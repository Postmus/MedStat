{
  "hash": "949bf4d9809914be102b4c297051c76d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Medical Statistics – Lab 4\"\nsubtitle: R version\nformat:\n  html:\n    toc: true\n    toc-depth: 3\n    toc-location: right\n    code-overflow: wrap\n  pdf:\n    toc: false\nexecute:\n  warning: false\n  message: false\n  error: false\n  eval: false\n---\n\nWelcome to lab 4 in the medical statistics course. In this lab, we will focus on the analysis of categorical data and the comparison of proportions between groups. We will also perform several statistical tests for the analysis of paired data.\n\nWe will use the following R packages: `haven`, `ggplot2`, and `rcompanion`. The first two packages were also used in the previous labs and therefore already installed on your computer. For `rcompanion` (used to perform pairwise chi-square tests) you may have to download and install it first by running `install.packages(\"rcompanion\")`.\n\n# Part 1: Inference for categorical data\n\n## Smoking and post-surgical complications\n\nA study was conducted to investigate whether smoking is associated with an increased risk of post-surgical complications. The relationship between smoking status (smoker or non-smoker) and the occurrence of complications following surgery was examined. The outcome of interest was whether or not a complication occurred (yes or no), with smoking status serving as the explanatory variable to compare complication rates between the two groups.\n\nThe data from the study are summarized in the following 2x2 contingency table:\n\n\n|            | Complication | No Complication | Total |\n|------------|--------------|------------------|-------|\n| Smokers    |      8       |        12        |   20  |\n| Non-smokers|     10       |        50        |   60  |\n| Total      |     18       |        62        |   80  |\n\n### Confidence intervals and hypothesis testing for the difference in proportions using the normal approximation\n\n::: {.callout-important icon=false title=\"Question 1\"}\nUsing the data provided in the table, calculate an approximate 95% confidence interval for the difference in proportions of post-surgical complications between smokers and non-smokers.\n:::\n\n::: {.callout-important icon=false title=\"Question 2\"}\nBased on the 95% confidence interval, can we conclude that there is a statistically significant difference in the proportion of post-surgical complications between smokers and non-smokers?\n:::\n\nWe can also use the normal approximation to test the hypothesis that the proportion of complications is the same for smokers and non-smokers. This test is known as the two-sample Z test for equality of proportions.\n\nAs explained in the syllabus, the two-sample Z test uses the pooled population proportion $\\hat{p}$, which is calculated as the total number of events divided by the total sample size. This pooled proportion is used under the null hypothesis, which assumes that the two groups share the same underlying proportion. The standard error of the difference in proportions is then calculated as $\\sqrt{\\hat{p}(1-\\hat{p})(1/n_1 + 1/n_2)}$, where $n_1$ and $n_2$ are the sample sizes in the two groups.\n\nIn contrast, the 95% confidence interval for the difference in proportions does not rely on the pooled proportion. Instead, it calculates the standard error separately for each group using the observed proportions, resulting in an unpooled standard error: $\\sqrt{\\frac{p_1(1-p_1)}{n_1} + \\frac{p_2(1-p_2)}{n_2}}$, where $p_1$ and $p_2$ are the sample proportions for each group. This approach provides an interval that better reflects the variability in the observed data, independent of the null hypothesis assumption.\n\nTo conduct the two-sample Z test, we start by creating a contingency table:\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a contingency table\ncomplications <- matrix(c(8, 12, 10, 50), nrow = 2, byrow = TRUE)\ncolnames(complications) <- c(\"Complication\", \"No Complication\")\nrownames(complications) <- c(\"Smokers\", \"Non-smokers\")\ncomplications <- as.table(complications)\ncomplications\n```\n:::\n\n\nNext, we supply this table to the `prop.test()` function to calculate the test statistic and p-value:\n\n::: {.cell}\n\n```{.r .cell-code}\nprop.test(complications)\n```\n:::\n\n\n::: {.callout-important icon=false title=\"Question 3\"}\nBased on the results of the test, can we conclude that there is a statistically significant difference in the proportion of post-surgical complications between smokers and non-smokers?\n:::\n\n::: {.callout-important icon=false title=\"Question 4\"}\nIn addition to the p-value, output of the `prop.test()` function also provides an approximate 95% confidence interval for the difference in proportions. How does this confidence interval compare to the one you calculated manually?\n:::\n\n### Checking of assumptions\n\nFor the use of the normal approximation to be valid, the expected number of events and non-events in each group should be at least 5.\n\n::: {.callout-important icon=false title=\"Exercise\"}\nCheck this assumption by calculating the expected counts for each cell in the contingency table.\n:::\n\n::: {.callout-important icon=false title=\"Question 5\"}\nIs it reasonable to use the normal approximation in this case?\n:::\n\n### Fisher's exact test\n\nWhen the expected cell counts are small, the normal approximation may not be appropriate. In such cases, Fisher's exact test is recommended for testing the association between two categorical variables.\n\nIn R, we can perform Fisher's exact test using the `fisher.test()` function. The test is based on the hypergeometric distribution and provides an exact p-value for the association between the two variables:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfisher.test(complications)\n```\n:::\n\n\n::: {.callout-important icon=false title=\"Question 6\"}\nBased on the results of Fisher's exact test, can we conclude that there is a statistically significant difference in the proportion of post-surgical complications between smokers and non-smokers?\n:::\n\n## Vaccine side effects across age groups\n\nA study was conducted to investigate whether the occurrence of vaccine side effects differs across age groups. Researchers categorized side effects into three types: none, mild, and severe. The study participants were divided into three age groups: 18–39, 40–59, and 60+, and data was collected on the type of side effect experienced by individuals in each group.\n\nThe research objective was to determine whether the distribution of side effects is consistent across these age groups.\n\nThe data is summarized in the following contingency table:\n\n| Age Group  | None | Mild | Severe | Total |\n|------------|------|------|--------|-------|\n| 18–39      | 50   | 30   | 10     | 90    |\n| 40–59      | 40   | 40   | 20     | 100   |\n| 60+        | 30   | 50   | 40     | 120   |\n| Total      | 120  | 120  | 70     | 310   |\n\n### Chi-square test of homogeneity\n\nTo conduct a chi-square test of homogeneity, we start by creating a contingency table:\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a contingency table\nside_effects <- matrix(c(50, 30, 10, 40, 40, 20, 30, 50, 40), nrow = 3, byrow = TRUE)\ncolnames(side_effects) <- c(\"None\", \"Mild\", \"Severe\")\nrownames(side_effects) <- c(\"18–39\", \"40–59\", \"60+\")\nside_effects <- as.table(side_effects)\nside_effects\n```\n:::\n\n\nNext, we supply this table to the `chisq.test()` function to calculate the test statistic and p-value:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchisq_test_overall <- chisq.test(side_effects)\nprint(chisq_test_overall)\n```\n:::\n\n\n::: {.callout-important icon=false title=\"Question 7\"}\nBased on the results of the chi-square test, can we conclude that the distribution of vaccine side effects is consistent across the three age groups?\n:::\n\n#### Checking of assumptions\n\nTo use the chi-square test, the expected cell counts should be at least 5 for most cells. To check this assumption, we retrieve the table of expected counts from the output of the `chisq.test()` function, which we stored in the `chisq_test_overall` object:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Retrieve the table of expected counts\nchisq_test_overall$expected\n```\n:::\n\n\n::: {.callout-important icon=false title=\"Question 8\"}\nAre the expected cell counts greater than 5 for the different cells in the contingency table?\n:::\n\n#### Post-hoc pairwise comparisons\n\nFinally, we are interested in determining which age groups have significantly different distributions of side effects. For a $n \\times 2$ table, this can be achieved easily using the `pairwise.prop.test()` function, which performs pairwise comparisons of proportions between groups with adjustments for multiple testing. However, in our case, we are working with a $3 \\times 3$ contingency table, where the outcomes have more than two categories (None, Mild, Severe).\n\nFor contingency tables with more than two outcome categories, we can use the `pairwiseNominalIndependence()` function from the `rcompanion` package. This function performs pairwise chi-square tests between all pairs of rows (or columns) and applies a correction for multiple testing:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(rcompanion)\npairwiseNominalIndependence(side_effects,\n                            compare = \"row\",\n                            fisher = FALSE,\n                            method = \"bonferroni\")\n```\n:::\n\n\nThe output shows the results of pairwise comparisons between all age groups. The key columns to focus on are:\n\n- **Comparison**: The pair of age groups being compared\n- **p.Chisq**: The unadjusted p-value from the chi-square test\n- **p.adj.Chisq**: The Bonferroni-adjusted p-value for multiple comparisons\n\nWe use the adjusted p-values (`p.adj.Chisq`) to determine statistical significance, as these account for the increased risk of Type I errors when performing multiple comparisons. At a significance level of 0.05, we can see that the distribution of side effects differs significantly between the 18–39 and 60+ age groups (adjusted p < 0.001), while the other pairwise comparisons are not statistically significant after correction.\n\n::: {.callout-note}\nThe output also includes p-values from the G-test (`p.Gtest` and `p.adj.Gtest`), which is an alternative to the chi-square test based on the likelihood ratio. In most cases, the chi-square and G-test give similar results.\n:::\n\nAlternatively, we can perform the pairwise comparisons manually to better understand the underlying process. We start by comparing the first two age groups (18–39 and 40–59). First, we set up the contingency table for these two groups:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable_12 <- side_effects[c(\"18–39\", \"40–59\"), ]\ntable_12\n```\n:::\n\n\nNext, we perform the chi-square test for this subset of the data and adjust the p-value by applying the Bonferroni correction:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Perform chi-square test for the subset of data\nchisq_test_12 <- chisq.test(table_12)\nprint(chisq_test_12)\n\n# Adjust the p-value for multiple testing\np_adjusted_12 <- 3*chisq_test_12$p.value\np_adjusted_12\n```\n:::\n\n\n:::{.callout-important icon=false title=\"Exercise\"}\nPerform the pairwise comparison between the other two pairs of age groups (40–59 and 60+, 18–39 and 60+) using the same approach.\n:::\n\n:::{.callout-important icon=false title=\"Question 9\"}\nBased on the results of the pairwise comparisons, which age groups have significantly different distributions of side effects?\n:::\n\n# Part 2: Analysis of paired continous data\n\n## Introduction\n\nIn this part of the lab, we will analyze paired data on pocket depth before and after an intervention. Pocket depth refers to the depth of the gum pockets around teeth, measured using a periodontal probe. It is an important indicator of periodontal health. Healthy gums typically have pocket depths less than 3 mm, while deeper pockets may indicate conditions such as gingivitis or periodontitis.\n\nThe dataset `pockets_paired.sav`, available from the Datasets menu, contains the following columns:\n\n- `subjectID`: Unique identifier for each participant\n- `pocket_depth_before`: Average pocket depth (in mm) measured before the intervention\n- `pocket_depth_after`: Average pocket depth (in mm) measured after the intervention\n\nThe objective is to determine whether the intervention significantly reduces pocket depth. We will apply three statistical methods to analyze the paired data:\n\n1. Paired t-test\n2. Sign test\n3. Wilcoxon signed-rank test\n\n### Paired t-test\n\nFirst, we load the data from the provided SPSS file `pockets_paired.sav`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(haven)\npockets <- read_sav(\"pockets_paired.sav\")\nhead(pockets)\n```\n:::\n\n\n\n\nNext, we perform a paired t-test to compare the average pocket depth before and after the intervention:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Perform paired t-test\nt_test <- t.test(pockets$pocket_depth_before,\n                 pockets$pocket_depth_after,\n                 paired = TRUE)\nprint(t_test)\n```\n:::\n\n\nThe `t.test()` function with the argument `paired = TRUE` conducts a paired t-test; setting `paired = FALSE` (default) would perform an independent samples t-test. The output includes the test statistic, degrees of freedom, and the p-value.\n\n:::{.callout-important icon=false title=\"Question 10\"}\nBased on the results of the paired t-test, can we conclude that the intervention significantly reduces pocket depth?\n:::\n\n#### Checking of assumptions\n\nTo determine whether it is appropriate to apply the paired t-test to these data, we need to verify that the differences in pocket depth before and after the intervention are normally distributed. We can visually inspect the distribution of differences using a histogram:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate the differences in pocket depth\npockets$diff <- pockets$pocket_depth_after -\n                pockets$pocket_depth_before\n\n# Create a histogram of the differences\nlibrary(ggplot2)\nggplot(pockets, aes(x = diff)) +\n  geom_histogram(binwidth = 0.05,\n                 fill = \"skyblue\",\n                 color = \"black\") +\n  labs(title = \"Distribution of differences in pocket depth\",\n       x = \"Difference in pocket depth (mm)\",\n       y = \"Frequency\")\n```\n:::\n\n\n:::{.callout-important icon=false title=\"Question 11\"}\nBased on the histogram, do the differences in pocket depth appear to be approximately normally distributed?\n:::\n\n### Sign test\n\nThe sign test is a non-parametric test used to compare two related samples. It is based on the signs of the differences between the pairs of observations. We will apply the sign test to the pocket depth data to determine whether the intervention has a significant effect.\n\nFirst, we calculate the total number of positive and negative signs in the differences:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate the number of positive and negative signs\nsigns_positive <- sum(pockets$diff > 0)\nsigns_negative <- sum(pockets$diff < 0)\n```\n:::\n\n\nNext, we perform the sign test using the `binom.test()` function, which calculates the exact p-value for the sign test:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Perform the sign test\nsign_test <- binom.test(signs_positive,\n                        signs_positive + signs_negative,\n                        p = 0.5)\nprint(sign_test)\n```\n:::\n\n\n:::{.callout-important icon=false title=\"Question 12\"}\nBased on the results of the sign test, can we conclude that the intervention significantly reduces pocket depth?\n:::\n\n### Wilcoxon signed-rank test\n\nThe Wilcoxon signed-rank test is another non-parametric test used to compare two related samples. It is based on the ranks of the absolute differences between the pairs of observations. In this case, the sign test is more appropriate because the Wilcoxon signed-rank test requires the assumption of symmetry in the distribution of differences, whereas the previously constructed histogram suggests that the distribution of these differences is left-skewed.\n\nTo perform the Wilcoxon signed-rank test, we use the `wilcox.test()` function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Perform the Wilcoxon signed-rank test\nwilcox_test <- wilcox.test(pockets$pocket_depth_before,\n                           pockets$pocket_depth_after,\n                           paired = TRUE)\nprint(wilcox_test)\n```\n:::\n\n\n:::{.callout-important icon=false title=\"Question 13\"}\nBased on the results of the Wilcoxon signed-rank test, can we conclude that the intervention significantly reduces pocket depth?\n:::\n\n# Part 3: Analysis of paired dichotomous data\n\nIn this part of the lab, we will analyze paired dichotomous data from a study investigating the skin response to two substances: **dinitrochlorobenzene (DNCB)**, a contact allergen, and **croton oil**, a skin irritant. The objective is to determine whether the proportion of patients with a negative response to DNCB is the same as the proportion with a negative response to croton oil.\n\nThe data, summarized in the following table, represents the results of simultaneous skin reaction tests on 173 patients with skin cancer:\n\n|               | DNCB +ve | DNCB -ve | Total |\n|---------------|----------|----------|-------|\n| **Croton oil +ve** | 81       | 23       | 104   |\n| **Croton oil -ve** | 48       | 21       | 69    |\n| **Total**      | 129      | 44       | 173   |\n\nBecause the data are paired, we will use the McNemar test to compare the proportions of positive and negative responses to DNCB and croton oil.\n\nFirst, we create a 2x2 contingency table from the data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create the table for DNCB and Croton Oil responses\nskin_response_table <- matrix(c(81, 23, 48, 21), nrow = 2, byrow = TRUE)\ncolnames(skin_response_table) <- c(\"DNCB +ve\", \"DNCB -ve\")\nrownames(skin_response_table) <- c(\"Croton Oil +ve\", \"Croton Oil -ve\")\nskin_response_table <- as.table(skin_response_table)\n\n# Print the table\nskin_response_table\n```\n:::\n\n\nNext, we perform the McNemar test using the `mcnemar.test()` function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Perform the McNemar test\nmcnemar_test <- mcnemar.test(skin_response_table)\nprint(mcnemar_test)\n```\n:::\n\n\n:::{.callout-important icon=false title=\"Question 14\"}\nBased on the results of the McNemar test, can we conclude that there is a significant difference in the proportions of patients with a negative response to DNCB and croton oil? If so, can you determine which substance is associated with a higher proportion of negative responses?\n:::\n",
    "supporting": [
      "R_lab4_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}